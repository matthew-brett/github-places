---
jupyter:
  jupytext:
    notebook_metadata_filter: all,-language_info
    split_at_heading: true
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.1.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import pandas as pd
```

```{python}
# Load user data
users = pd.read_csv('users_locations.csv')
users.head()
```

```{python}
# Load country data
country_data = pd.read_csv('country_data.csv')
```

```{python}
# Review users where country is N/K (not known).
nk_users = users[users['country_code'] == 'N/K']
nk_users = nk_users[['repo', 'n_commits', 'gh_user']]
nk_users
```

What percentage of the commits are not accounted for?

```{python}
nk_users['n_commits'].sum() / users['n_commits'].sum() * 100
```

For what percentage of Github users do I have to specify the location?

```{python}
from contrib_countries import GH_USER2LOCATION
```

```{python}
len(GH_USER2LOCATION) / len(users) * 100
```

For what percentage of users identified in `git shortlog` do I have to specify the Github user?

```{python}
from find_gh_users import NAME2GH_USER
n_specified = sum(len(v) for k, v in NAME2GH_USER.items())
n_specified / len(users) * 100
```

Aggregate over Github user:

```{python}
def aggregate_user(sub_df):
    first = sub_df.iloc[0]
    out = sub_df.iloc[0][['name', 'country_code']]
    out['n_commits'] = sub_df['n_commits'].sum()
    out['repos'] = '; '.join(f"{row['repo']}: {row['n_commits']}"
                    for i, row in sub_df.iterrows())
    return out
```

```{python}
by_gh_user = users.groupby('gh_user').apply(aggregate_user)
by_gh_user = by_gh_user.sort_values('n_commits', ascending=False)
by_gh_user.head()
```

```{python}
# Merge by Country
by_country = (by_gh_user.groupby('country_code').sum()
              .sort_values('n_commits', ascending=False))
by_country.head(10)
```

```{python}
population = country_data[['country_code', 'population']]
by_country_pop = by_country.merge(population, on='country_code')
by_country_pop.head(10)
```

```{python}
by_country_pop['commits_per_million'] = (by_country_pop['n_commits'] /
                                         by_country_pop['population'])
by_country_pop = (by_country_pop
                  .head(10)
                  .sort_values('commits_per_million', ascending=False))
by_country_pop
```
